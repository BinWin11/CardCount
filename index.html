<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>
  <title>牌局记账 v4（localStorage + 自动胜者金额 + 图表）</title>
  <style>
    :root{
      --bg:#0b1220; --card:#121a2b; --muted:#7f8aa3; --text:#e8eefc;
      --ok:#25c26e; --bad:#ff5c6c; --warn:#ffcc66; --line:rgba(255,255,255,.09);
      --btn:#2a3a63; --btn2:#1c2743; --shadow:0 10px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    body{
      margin:0; color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"PingFang SC","Microsoft Yahei",sans-serif;
      background:linear-gradient(180deg,#070c16,#0b1220 30%,#070c16);
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    .topbar{
      position:sticky; top:0; z-index:30;
      background:rgba(7,12,22,.75); backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);
    }
    .topbar-inner{
      max-width:1100px;margin:0 auto;padding:10px 14px;
      display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;
    }
    .title{font-weight:900;font-size:16px}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tabbtn{
      border:1px solid var(--line); border-radius:999px;
      padding:8px 12px; cursor:pointer; user-select:none;
      background:rgba(18,26,43,.6);
      font-size:13px;
    }
    .tabbtn.active{background:linear-gradient(180deg,var(--btn),var(--btn2));}
    .actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    button{
      background:linear-gradient(180deg,var(--btn),var(--btn2));
      border:1px solid var(--line);
      color:var(--text); border-radius:12px;
      padding:10px 12px; font-size:14px; cursor:pointer;
      box-shadow:0 8px 18px rgba(0,0,0,.18);
    }
    button:hover{filter:brightness(1.08)}
    .btn-ghost{background:transparent;box-shadow:none}
    .btn-danger{background:linear-gradient(180deg,#5b2230,#3a1620);border-color:rgba(255,92,108,.25)}
    .btn-ok{background:linear-gradient(180deg,#1f5a3b,#143524);border-color:rgba(37,194,110,.25)}
    .wrap{max-width:1100px;margin:0 auto;padding:14px;}
    .grid{display:grid;grid-template-columns:1fr;gap:12px;margin-top:12px;}
    @media (min-width:900px){ .grid{grid-template-columns:1.2fr .8fr;} }
    .card{
      background:rgba(18,26,43,.92);
      border:1px solid var(--line);
      border-radius:14px;
      padding:14px;
      box-shadow:var(--shadow);
    }
    .pill{display:inline-block;padding:3px 8px;border:1px solid var(--line);border-radius:999px;font-size:12px;color:var(--muted)}
    .muted{color:var(--muted);font-size:12px;line-height:1.5}
    .sep{height:1px;background:var(--line);margin:12px 0}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    label{font-size:12px;color:var(--muted)}
    input,select{
      background:#0d1426;color:var(--text);border:1px solid var(--line);
      border-radius:12px;padding:10px 10px;font-size:15px;outline:none;
    }
    input:focus,select:focus{border-color:rgba(255,255,255,.25)}
    input[type="text"]{min-width:160px}
    select{min-width:150px}
    input[readonly]{opacity:.9}
    .msg{font-size:13px;margin-top:8px}
    .msg.ok{color:var(--ok)} .msg.bad{color:var(--bad)} .msg.warn{color:var(--warn)}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--line);padding:10px 6px;text-align:left;font-size:14px}
    th{color:var(--muted);font-weight:800;font-size:12px}
    .pos{color:var(--ok);font-weight:900}
    .neg{color:var(--bad);font-weight:900}

    /* Drawer（明细） */
    .drawer-mask{position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:90; display:none;}
    .drawer{
      position:fixed; top:0; right:0; height:100vh;
      width:min(520px, 92vw);
      background:rgba(18,26,43,.98); backdrop-filter: blur(10px);
      border-left:1px solid var(--line);
      z-index:100;
      transform: translateX(110%);
      transition: transform .25s ease;
      display:flex; flex-direction:column;
      box-shadow: -14px 0 40px rgba(0,0,0,.45);
    }
    .drawer.open{transform: translateX(0);}
    .drawer-head{padding:12px 12px;border-bottom:1px solid var(--line);display:flex;gap:10px;align-items:center;justify-content:space-between}
    .drawer-body{padding:12px;overflow:auto}
    details{border:1px solid var(--line);border-radius:12px;padding:10px 10px;margin:10px 0;background:rgba(0,0,0,.14)}
    summary{cursor:pointer;list-style:none}
    summary::-webkit-details-marker{display:none}
    .flex-between{display:flex;justify-content:space-between;gap:10px;align-items:center;flex-wrap:wrap}
    .small{font-size:12px}

    /* 金额输入块 */
    .amt-box{min-width:250px;flex:1}
    .amt-line{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:6px}
    .amt-line input[type="number"]{width:120px}
    .quickbar{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .chip{
      border:1px solid var(--line); border-radius:999px;
      padding:7px 10px; font-size:13px; cursor:pointer;
      background:rgba(0,0,0,.12); user-select:none;
    }
    .chip:hover{filter:brightness(1.1)}
    .badgeWinner{
      display:inline-block; padding:3px 8px; border-radius:999px;
      border:1px solid rgba(37,194,110,.25);
      color:var(--ok); font-size:12px; font-weight:800;
      background:rgba(31,90,59,.25);
      margin-left:6px;
    }

    /* 保存确认弹窗 */
    .modal-mask{
      position:fixed; inset:0; background:rgba(0,0,0,.55);
      z-index:120; display:none;
      align-items:center; justify-content:center;
      padding:14px;
    }
    .modal{
      width:min(640px, 96vw);
      background:rgba(18,26,43,.98);
      border:1px solid var(--line);
      border-radius:16px;
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .modal-head{padding:12px 14px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center}
    .modal-body{padding:14px;max-height:min(70vh,520px);overflow:auto}
    .list-item{padding:10px 10px;border:1px solid var(--line);border-radius:12px;margin:10px 0;background:rgba(0,0,0,.14)}
    .home-chart{
      width:100%; height:260px;
      border:1px solid var(--line);
      border-radius:14px;
      background:rgba(0,0,0,.18);
    }
    @media (min-width:900px){ .home-chart{height:320px;} }
  </style>
</head>

<body>

<div class="topbar">
  <div class="topbar-inner">
    <div class="title">牌局记账 v4 <span style="opacity:.6;font-size:12px;">（localStorage 优先）</span></div>
    <div class="tabs">
      <div class="tabbtn active" id="tabHomeBtn">主页</div>
      <div class="tabbtn" id="tabEditBtn">记账</div>
      <div class="tabbtn" id="tabSettingsBtn">设置</div>
    </div>
    <div class="actions">
      <button class="btn-ghost" id="btnOpenDetails">明细侧边栏</button>
      <button class="btn-danger" id="btnResetAll">清空全部（多次确认）</button>
    </div>
  </div>
</div>

<div class="wrap">
  <!-- HOME -->
  <div id="tabHome">
    <div class="grid">
      <div class="card">
        <div class="flex-between">
          <div>
            <div class="pill">累计看板</div>
            <div class="muted" id="metaInfo" style="margin-top:6px;"></div>
          </div>
          <button class="btn-ghost" id="btnRefresh">刷新</button>
        </div>
        <div class="sep"></div>
        <table>
          <thead><tr><th>玩家</th><th>累计输赢</th></tr></thead>
          <tbody id="scoreboardBody"></tbody>
        </table>

        <div class="sep"></div>
        <div class="pill">汇总图表（趋势）</div>
        <div class="muted" style="margin:8px 0;">
          每局结束后的累计金额变化（底部图表持续展示）。
        </div>
        <canvas id="trendChart" class="home-chart"></canvas>
      </div>

      <div class="card">
        <div class="pill">快捷操作</div>
        <div class="sep"></div>
        <div class="row">
          <button class="btn-ok" id="btnGoEdit">去记一局</button>
          <button class="btn-ghost" id="btnGoSettings">去设置</button>
        </div>
        <div class="sep"></div>
        <div class="pill">本版本规则</div>
        <div class="muted" style="margin-top:8px;">
          - 胜利者无需输入金额：系统自动把输家金额相加，作为胜利者赢额。<br/>
          - 输家输入为“绝对值”，系统会自动加负号。<br/>
          - 保存前弹窗展示本局最终带符号金额，确认后写入存储。<br/>
          - 存储优先 localStorage（更适合 iOS 长期使用）。
        </div>
      </div>
    </div>
  </div>

  <!-- EDIT -->
  <div id="tabEdit" style="display:none;">
    <div class="card">
      <div class="flex-between">
        <div>
          <div class="pill">记一局（胜者自动计算）</div>
          <div class="muted" style="margin-top:6px;">
            输家金额支持：手动输入、快捷 1/2/3/6、下拉 1~6（iOS 原生滚轮）。
          </div>
        </div>
        <div class="row">
          <button class="btn-ghost" id="btnClearInputs">清空本局输入</button>
        </div>
      </div>

      <div class="sep"></div>

      <div class="row">
        <div>
          <label>人数</label><br/>
          <select id="playerCountReadOnly" disabled></select>
        </div>

        <div>
          <label>胜利者</label><br/>
          <select id="winnerSelect"></select>
        </div>
      </div>

      <div id="amountInputsBox" class="row" style="margin-top:12px;"></div>
      <div id="sumMsg" class="msg"></div>

      <div class="sep"></div>
      <div class="row">
        <button class="btn-ok" id="btnRequestSave">保存（先确认）</button>
        <span class="muted" id="storageHint"></span>
      </div>
    </div>
  </div>

  <!-- SETTINGS -->
  <div id="tabSettings" style="display:none;">
    <div class="card">
      <div class="pill">基础设置</div>
      <div class="muted" style="margin-top:6px;">
        默认姓名可选：彬、芹、燕、令；也支持自定义。
      </div>

      <div class="sep"></div>

      <div class="row">
        <div>
          <label>人数</label><br/>
          <select id="playerCount">
            <option value="4">4 人</option>
            <option value="3">3 人</option>
          </select>
        </div>
        <div class="muted">切换人数后，下面只显示对应人数的姓名配置。</div>
      </div>

      <div class="sep"></div>

      <div id="playerNamesBox" class="row"></div>

      <div class="row" style="margin-top:10px;">
        <button id="btnSaveSettings">保存设置</button>
      </div>
    </div>
  </div>
</div>

<!-- 明细侧边栏 -->
<div class="drawer-mask" id="drawerMask"></div>
<div class="drawer" id="drawer">
  <div class="drawer-head">
    <div>
      <div style="font-weight:900">局数明细</div>
      <div class="muted small" id="drawerMeta"></div>
    </div>
    <div class="row">
      <button class="btn-ghost" id="btnCloseDetails">关闭</button>
    </div>
  </div>
  <div class="drawer-body">
    <div class="row">
      <button class="btn-ghost" id="btnDeleteLast">删除最后一局</button>
    </div>
    <div id="roundsBox" style="margin-top:10px;"></div>
  </div>
</div>

<!-- 保存确认弹窗 -->
<div class="modal-mask" id="confirmMask">
  <div class="modal">
    <div class="modal-head">
      <div style="font-weight:900">确认保存本局？</div>
      <button class="btn-ghost" id="btnCloseConfirm">关闭</button>
    </div>
    <div class="modal-body">
      <div class="muted">本局最终金额（胜者自动计算）：</div>
      <div class="sep"></div>
      <div id="confirmList"></div>
      <div class="sep"></div>
      <div class="muted" id="confirmSum"></div>
      <div class="sep"></div>
      <div class="row">
        <button class="btn-ok" id="btnConfirmSave">确认保存</button>
        <button class="btn-ghost" id="btnCancelSave">取消</button>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  const KEY = "POKER_MONEY_V4";
  const COOKIE_FALLBACK_KEY = "POKER_MONEY_V4_COOKIE";
  const PRESET_NAMES = ["彬","芹","燕","令"];

  // ---------- Storage Adapter (localStorage 优先，Cookie 兜底) ----------
  function cookieSet(name, value, days){
    const d = new Date();
    d.setTime(d.getTime() + (days||365)*24*60*60*1000);
    document.cookie = name + "=" + encodeURIComponent(value) + ";expires=" + d.toUTCString() + ";path=/";
  }
  function cookieGet(name){
    const parts = document.cookie.split(";").map(s=>s.trim());
    for(const p of parts){
      if(p.startsWith(name + "=")) return decodeURIComponent(p.substring(name.length+1));
    }
    return "";
  }
  function cookieDel(name){
    document.cookie = name + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/";
  }

  function lsAvailable(){
    try{
      const t="__t__";
      localStorage.setItem(t,"1");
      localStorage.removeItem(t);
      return true;
    }catch(e){ return false; }
  }

  const storage = {
    type: lsAvailable() ? "localStorage" : "cookie",
    load(){
      const raw = (this.type==="localStorage") ? localStorage.getItem(KEY) : cookieGet(COOKIE_FALLBACK_KEY);
      if(raw) return raw;

      // 兼容：如果 cookie 里有旧数据而 localStorage 没有，尝试迁移
      if(this.type==="localStorage"){
        const old = cookieGet(COOKIE_FALLBACK_KEY);
        if(old){
          localStorage.setItem(KEY, old);
          return old;
        }
      }
      return "";
    },
    save(raw){
      if(this.type==="localStorage"){
        localStorage.setItem(KEY, raw);
      }else{
        cookieSet(COOKIE_FALLBACK_KEY, raw, 365);
      }
    },
    clear(){
      if(this.type==="localStorage"){
        localStorage.removeItem(KEY);
      }
      cookieDel(COOKIE_FALLBACK_KEY);
    }
  };

  // ---------- State ----------
  function defaultState(){
    return {
      playerCount: 4,
      players: ["彬","芹","燕","令"],
      rounds: [] // {id, ts, winnerIndex, amounts:[signed]}
    };
  }
  function loadState(){
    const raw = storage.load();
    if(!raw) return defaultState();
    try{
      const obj = JSON.parse(raw);
      if(!obj || !Array.isArray(obj.players) || !Array.isArray(obj.rounds)) return defaultState();
      if(obj.playerCount !== 3 && obj.playerCount !== 4) obj.playerCount = obj.players.length || 4;
      return obj;
    }catch(e){ return defaultState(); }
  }
  function saveState(){
    storage.save(JSON.stringify(state));
  }

  let state = loadState();
  let pendingSigned = null;
  let pendingWinner = null;

  // ---------- DOM ----------
  const $ = (id)=>document.getElementById(id);

  const tabHomeBtn = $("tabHomeBtn");
  const tabEditBtn = $("tabEditBtn");
  const tabSettingsBtn = $("tabSettingsBtn");
  const tabHome = $("tabHome");
  const tabEdit = $("tabEdit");
  const tabSettings = $("tabSettings");

  const metaInfo = $("metaInfo");
  const scoreboardBody = $("scoreboardBody");
  const trendChart = $("trendChart");

  const btnGoEdit = $("btnGoEdit");
  const btnGoSettings = $("btnGoSettings");
  const btnRefresh = $("btnRefresh");

  const playerCountEl = $("playerCount");
  const playerNamesBox = $("playerNamesBox");
  const btnSaveSettings = $("btnSaveSettings");

  const playerCountReadOnly = $("playerCountReadOnly");
  const winnerSelect = $("winnerSelect");
  const amountInputsBox = $("amountInputsBox");
  const sumMsg = $("sumMsg");
  const btnClearInputs = $("btnClearInputs");
  const btnRequestSave = $("btnRequestSave");
  const storageHint = $("storageHint");

  const drawer = $("drawer");
  const drawerMask = $("drawerMask");
  const btnOpenDetails = $("btnOpenDetails");
  const btnCloseDetails = $("btnCloseDetails");
  const roundsBox = $("roundsBox");
  const drawerMeta = $("drawerMeta");
  const btnDeleteLast = $("btnDeleteLast");

  const btnResetAll = $("btnResetAll");

  const confirmMask = $("confirmMask");
  const btnCloseConfirm = $("btnCloseConfirm");
  const btnCancelSave = $("btnCancelSave");
  const btnConfirmSave = $("btnConfirmSave");
  const confirmList = $("confirmList");
  const confirmSum = $("confirmSum");

  function escapeHtml(str){
    return String(str).replace(/[&<>"']/g, s=>({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[s]));
  }
  function showMsg(type, text){
    sumMsg.className = "msg " + (type||"");
    sumMsg.textContent = text || "";
  }

  function openTab(name){
    const isHome = name==="home";
    const isEdit = name==="edit";
    const isSettings = name==="settings";
    tabHome.style.display = isHome ? "" : "none";
    tabEdit.style.display = isEdit ? "" : "none";
    tabSettings.style.display = isSettings ? "" : "none";
    tabHomeBtn.classList.toggle("active", isHome);
    tabEditBtn.classList.toggle("active", isEdit);
    tabSettingsBtn.classList.toggle("active", isSettings);
    if(isHome) drawTrendChart();
  }

  // ---------- Core compute ----------
  function computeTotals(){
    const n = state.playerCount;
    const totals = new Array(n).fill(0);
    for(const r of state.rounds){
      const am = Array.isArray(r.amounts) ? r.amounts : [];
      for(let i=0;i<n;i++) totals[i] += Number(am[i]||0);
    }
    return totals;
  }

  // 金额输入：输家输入绝对值；胜者自动=输家之和
  function buildSelect1to6(){
    return `
      <option value="">下拉选</option>
      ${[1,2,3,4,5,6].map(v=>`<option value="${v}">${v}</option>`).join("")}
    `;
  }
  function quickChips(i){
    const vals = [1,2,3,6];
    return `
      <div class="quickbar">
        ${vals.map(v=>`<div class="chip" data-idx="${i}" data-v="${v}">${v}</div>`).join("")}
        <div class="chip" data-idx="${i}" data-v="0">0</div>
      </div>
    `;
  }

  function getLoserAbs(i){
    const inp = $("amtInp_"+i);
    const sel = $("amtSel_"+i);
    let v = "";
    if(inp && inp.value !== "") v = inp.value;
    else if(sel && sel.value !== "") v = sel.value;
    if(v === "") return 0;
    const num = Math.abs(Number(v));
    return Number.isFinite(num) ? num : 0;
  }
  function setLoserAbs(i, val){
    const inp = $("amtInp_"+i);
    const sel = $("amtSel_"+i);
    if(inp) inp.value = String(val);
    if(sel) sel.value = "";
    recalcPreview();
  }

  function recalcPreview(){
    const n = state.playerCount;
    const win = Number(winnerSelect.value);
    if(win < 0 || win >= n){
      // 清空胜者只读显示
      for(let i=0;i<n;i++){
        const w = $("winnerTag_"+i); if(w) w.innerHTML = "";
        const ro = $("amtRO_"+i); if(ro) ro.value = "";
        const row = $("rowHint_"+i); if(row) row.textContent = "";
      }
      showMsg("warn","请选择胜利者，然后填写输家金额（胜者自动计算）。");
      return {ok:false};
    }

    // 胜者标签
    for(let i=0;i<n;i++){
      const tag = $("winnerTag_"+i);
      if(tag) tag.innerHTML = (i===win) ? `<span class="badgeWinner">胜利者（自动）</span>` : "";
    }

    // 计算输家总额
    let loserSum = 0;
    for(let i=0;i<n;i++){
      if(i===win) continue;
      loserSum += getLoserAbs(i);
    }

    // signed amounts
    const signed = new Array(n).fill(0);
    for(let i=0;i<n;i++){
      if(i===win) signed[i] = +loserSum;
      else signed[i] = -getLoserAbs(i);
    }

    // 更新胜者只读显示
    const ro = $("amtRO_"+win);
    if(ro) ro.value = String(loserSum);

    // 给每行提示本局最终带符号
    for(let i=0;i<n;i++){
      const hint = $("rowHint_"+i);
      if(!hint) continue;
      const v = signed[i];
      hint.textContent = `本局：${v>=0?"+":""}${v}`;
      hint.className = "muted " + (v>=0 ? "pos":"neg");
    }

    const sum = signed.reduce((a,b)=>a+b,0);
    // 理论上总是0（胜者=输家和），这里仍提示
    if(Math.abs(sum) < 1e-9){
      showMsg("ok",`胜者自动计算完成：胜者赢 ${loserSum}，合计为 0，可保存（会弹确认）。`);
      return {ok:true, signed, winner:win, sum};
    }else{
      showMsg("bad",`合计异常：${sum}（请检查输入）。`);
      return {ok:false, signed, winner:win, sum};
    }
  }

  // ---------- UI rebuild ----------
  function rebuildHome(){
    const totals = computeTotals();
    scoreboardBody.innerHTML = "";
    for(let i=0;i<state.playerCount;i++){
      const val = totals[i];
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${escapeHtml(state.players[i]||("玩家"+(i+1)))}</td>
        <td class="${val>=0?"pos":"neg"}">${val>=0?"+":""}${val}</td>
      `;
      scoreboardBody.appendChild(tr);
    }
    metaInfo.textContent = `人数：${state.playerCount}；局数：${state.rounds.length}`;
  }

  function rebuildSettings(){
    playerCountEl.value = String(state.playerCount);
    playerNamesBox.innerHTML = "";
    const n = state.playerCount;

    for(let i=0;i<n;i++){
      const current = state.players[i] || "";
      const isPreset = PRESET_NAMES.includes(current);
      const wrap = document.createElement("div");
      wrap.style.minWidth = "260px";
      wrap.innerHTML = `
        <label>玩家 ${i+1}</label><br/>
        <div class="amt-line">
          <select id="nameSel_${i}">
            <option value="">请选择</option>
            ${PRESET_NAMES.map(nm=>`<option value="${escapeHtml(nm)}"${nm===current?" selected":""}>${escapeHtml(nm)}</option>`).join("")}
            <option value="__custom__"${isPreset ? "" : " selected"}>自定义</option>
          </select>
          <input type="text" id="nameCustom_${i}" placeholder="自定义姓名" value="${isPreset ? "" : escapeHtml(current)}" ${isPreset ? "disabled":""}/>
        </div>
        <div class="muted">选择默认姓名或切到“自定义”输入</div>
      `;
      playerNamesBox.appendChild(wrap);
    }

    for(let i=0;i<n;i++){
      $("nameSel_"+i).addEventListener("change", ()=>{
        const selV = $("nameSel_"+i).value;
        const inp = $("nameCustom_"+i);
        if(selV === "__custom__"){
          inp.disabled = false;
          inp.focus();
        }else{
          inp.value = "";
          inp.disabled = true;
        }
      });
    }
  }

  function rebuildEdit(){
    storageHint.textContent = `当前存储：${storage.type}（iOS 推荐 localStorage）`;
    playerCountReadOnly.innerHTML = `<option>${state.playerCount} 人</option>`;

    // winner select
    winnerSelect.innerHTML = `<option value="-1">请选择胜利者</option>`;
    for(let i=0;i<state.playerCount;i++){
      const opt = document.createElement("option");
      opt.value = String(i);
      opt.textContent = state.players[i] || ("玩家"+(i+1));
      winnerSelect.appendChild(opt);
    }

    // amount inputs (输家可输入；胜者只读)
    amountInputsBox.innerHTML = "";
    const n = state.playerCount;
    const selOpt = buildSelect1to6();

    for(let i=0;i<n;i++){
      const name = state.players[i] || ("玩家"+(i+1));
      const box = document.createElement("div");
      box.className = "amt-box";
      box.innerHTML = `
        <label>${escapeHtml(name)} <span id="winnerTag_${i}"></span></label>
        <div class="amt-line" id="line_${i}">
          <input type="number" id="amtInp_${i}" inputmode="numeric" min="0" step="1" placeholder="手动输入(输家)" />
          <select id="amtSel_${i}">${selOpt}</select>
          <input type="number" id="amtRO_${i}" readonly placeholder="胜者自动" style="display:none;width:140px"/>
        </div>
        ${quickChips(i)}
        <div id="rowHint_${i}" class="muted"></div>
      `;
      amountInputsBox.appendChild(box);
    }

    // chips events
    amountInputsBox.querySelectorAll(".chip").forEach(chip=>{
      chip.addEventListener("click", ()=>{
        const idx = Number(chip.getAttribute("data-idx"));
        const v = Number(chip.getAttribute("data-v"));
        // 若当前 idx 是胜者，不允许手改（胜者自动）
        if(Number(winnerSelect.value) === idx) return;
        setLoserAbs(idx, v);
      });
    });

    // input/select events
    for(let i=0;i<n;i++){
      $("amtInp_"+i).addEventListener("input", ()=>{
        if(Number(winnerSelect.value) === i) return;
        $("amtSel_"+i).value = "";
        recalcPreview();
      });
      $("amtSel_"+i).addEventListener("change", ()=>{
        if(Number(winnerSelect.value) === i) return;
        if($("amtSel_"+i).value !== "") $("amtInp_"+i).value = "";
        recalcPreview();
      });
    }

    winnerSelect.addEventListener("change", ()=>{
      // 切换胜者：把胜者行切到只读，其余行切到可输入
      const win = Number(winnerSelect.value);
      for(let i=0;i<n;i++){
        const inp = $("amtInp_"+i);
        const sel = $("amtSel_"+i);
        const ro = $("amtRO_"+i);
        if(i === win){
          // 隐藏输家输入，显示只读
          inp.value = ""; sel.value = "";
          inp.style.display = "none";
          sel.style.display = "none";
          ro.style.display = "";
        }else{
          inp.style.display = "";
          sel.style.display = "";
          ro.style.display = "none";
          ro.value = "";
        }
      }
      recalcPreview();
    });

    showMsg("warn","请选择胜利者，然后填写输家金额（胜者自动计算）。");
  }

  function rebuildDrawer(){
    drawerMeta.textContent = `共 ${state.rounds.length} 局（最新在上）`;
    roundsBox.innerHTML = "";
    if(state.rounds.length === 0){
      roundsBox.innerHTML = `<div class="muted">暂无记录。</div>`;
      return;
    }
    const n = state.playerCount;
    const rounds = [...state.rounds].sort((a,b)=>b.ts-a.ts);
    for(const r of rounds){
      const idx = state.rounds.findIndex(x=>x.id===r.id);
      const dt = new Date(r.ts);
      const tsStr = dt.toLocaleString();
      const sum = (r.amounts||[]).slice(0,n).reduce((a,b)=>a+Number(b||0),0);
      const sumOk = Math.abs(sum) < 1e-9;

      const detailRows = (r.amounts||[]).slice(0,n).map((v,i)=>{
        const num = Number(v||0);
        return `<tr><td>${escapeHtml(state.players[i]||("玩家"+(i+1)))}</td>
                <td class="${num>=0?"pos":"neg"}">${num>=0?"+":""}${num}</td></tr>`;
      }).join("");

      const box = document.createElement("details");
      box.innerHTML = `
        <summary class="flex-between">
          <div>
            <div class="${sumOk?"pos":"neg"}" style="font-weight:900">
              第 ${idx+1} 局 · ${tsStr} · 合计 ${sumOk?"0":"≠0"}
            </div>
            <div class="muted small">胜者：${escapeHtml(state.players[r.winnerIndex]||"")}</div>
          </div>
          <div class="row">
            <button class="btn-danger" data-del="${r.id}" type="button">删除</button>
          </div>
        </summary>
        <div style="margin-top:10px;">
          <table>
            <thead><tr><th>玩家</th><th>本局</th></tr></thead>
            <tbody>${detailRows}</tbody>
          </table>
        </div>
      `;
      roundsBox.appendChild(box);
    }

    roundsBox.querySelectorAll("button[data-del]").forEach(btn=>{
      btn.addEventListener("click",(e)=>{
        e.preventDefault();
        const id = btn.getAttribute("data-del");
        deleteRound(id);
      });
    });
  }

  function rebuildAll(){
    // 修正 players 长度
    if(!Array.isArray(state.players) || state.players.length===0) state.players = PRESET_NAMES.slice();
    if(state.playerCount !== 3 && state.playerCount !== 4) state.playerCount = 4;
    state.players = state.players.slice(0, state.playerCount);
    while(state.players.length < state.playerCount){
      state.players.push(PRESET_NAMES[state.players.length] || ("玩家"+(state.players.length+1)));
    }

    rebuildHome();
    rebuildSettings();
    rebuildEdit();
    rebuildDrawer();
    drawTrendChart();
  }

  // ---------- Confirm Save ----------
  function openConfirmModal(signed, sum){
    confirmList.innerHTML = "";
    for(let i=0;i<state.playerCount;i++){
      const v = signed[i];
      const item = document.createElement("div");
      item.className = "list-item";
      item.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;">
          <div style="font-weight:900;">${escapeHtml(state.players[i]||("玩家"+(i+1)))}</div>
          <div class="${v>=0?"pos":"neg"}" style="font-size:16px;">${v>=0?"+":""}${v}</div>
        </div>
      `;
      confirmList.appendChild(item);
    }
    confirmSum.innerHTML = `本局合计：<b style="color:${Math.abs(sum)<1e-9 ? 'var(--ok)' : 'var(--bad)'}">${sum}</b>（应为 0）`;
    confirmMask.style.display = "flex";
  }
  function closeConfirmModal(){ confirmMask.style.display = "none"; }

  function requestSave(){
    const res = recalcPreview();
    if(!res.ok) return;
    pendingSigned = res.signed;
    pendingWinner = res.winner;
    openConfirmModal(res.signed, res.sum);
  }

  function confirmSave(){
    if(!pendingSigned) return;
    state.rounds.push({
      id: "R" + Date.now().toString(36) + Math.random().toString(36).slice(2,6),
      ts: Date.now(),
      winnerIndex: pendingWinner,
      amounts: pendingSigned.slice()
    });
    saveState();
    pendingSigned = null;
    pendingWinner = null;
    closeConfirmModal();
    rebuildHome();
    rebuildDrawer();
    drawTrendChart();
    clearInputs();
    alert("已保存本局。");
  }

  function clearInputs(){
    winnerSelect.value = "-1";
    for(let i=0;i<state.playerCount;i++){
      const inp = $("amtInp_"+i);
      const sel = $("amtSel_"+i);
      const ro = $("amtRO_"+i);
      const tag = $("winnerTag_"+i);
      const hint = $("rowHint_"+i);
      if(inp){ inp.value=""; inp.style.display=""; }
      if(sel){ sel.value=""; sel.style.display=""; }
      if(ro){ ro.value=""; ro.style.display="none"; }
      if(tag) tag.innerHTML="";
      if(hint) hint.textContent="";
    }
    showMsg("warn","请选择胜利者，然后填写输家金额（胜者自动计算）。");
  }

  // ---------- Settings Save ----------
  function saveSettings(){
    const n = Number(playerCountEl.value);
    state.playerCount = n;

    const players = [];
    for(let i=0;i<n;i++){
      const selV = $("nameSel_"+i)?.value || "";
      const customV = ($("nameCustom_"+i)?.value || "").trim();
      if(selV && selV !== "__custom__") players.push(selV);
      else players.push(customV || ("玩家"+(i+1)));
    }
    state.players = players;

    saveState();
    rebuildAll();
    alert("设置已保存。");
  }

  // ---------- Drawer ----------
  function openDrawer(){ drawerMask.style.display="block"; drawer.classList.add("open"); }
  function closeDrawer(){ drawerMask.style.display="none"; drawer.classList.remove("open"); }

  // ---------- Delete / Reset ----------
  function deleteRound(id){
    const idx = state.rounds.findIndex(r=>r.id===id);
    if(idx<0) return;
    if(!confirm("确定删除该局吗？")) return;
    state.rounds.splice(idx,1);
    saveState();
    rebuildHome();
    rebuildDrawer();
    drawTrendChart();
  }
  function deleteLast(){
    if(state.rounds.length===0) return;
    const idx = state.rounds.length-1;
    if(!confirm(`确定删除最后一局（第 ${idx+1} 局）吗？`)) return;
    state.rounds.splice(idx,1);
    saveState();
    rebuildHome();
    rebuildDrawer();
    drawTrendChart();
  }
  function resetAll(){
    if(!confirm("第 1 次确认：确定清空全部数据吗？")) return;
    if(!confirm("第 2 次确认：清空后不可恢复，确定吗？")) return;
    if(!confirm("第 3 次确认：最后确认，真的要清空吗？")) return;
    storage.clear();
    state = {
      playerCount: 4,
      players: ["彬","芹","燕","令"],
      rounds: []
    };
    saveState();
    rebuildAll();
    clearInputs();
    alert("已清空。");
  }

  // ---------- Chart ----------
  function drawTrendChart(){
    const canvas = trendChart;
    const ctx = canvas.getContext("2d");

    const dpr = Math.max(1, Math.floor(window.devicePixelRatio || 1));
    const rect = canvas.getBoundingClientRect();
    canvas.width = Math.floor(rect.width * dpr);
    canvas.height = Math.floor(rect.height * dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);

    ctx.clearRect(0,0,rect.width,rect.height);

    const n = state.playerCount;
    const rounds = state.rounds.slice().sort((a,b)=>a.ts-b.ts);
    const pointsCount = rounds.length + 1;
    const series = new Array(n).fill(0).map(()=> new Array(pointsCount).fill(0));

    const acc = new Array(n).fill(0);
    for(let i=0;i<n;i++) series[i][0]=0;
    rounds.forEach((r, idx)=>{
      for(let i=0;i<n;i++){
        acc[i] += Number((r.amounts||[])[i]||0);
        series[i][idx+1] = acc[i];
      }
    });

    let minV = 0, maxV = 0;
    for(let i=0;i<n;i++){
      for(let k=0;k<pointsCount;k++){
        minV = Math.min(minV, series[i][k]);
        maxV = Math.max(maxV, series[i][k]);
      }
    }
    if(minV === maxV){ minV -= 1; maxV += 1; }

    const padL = 44, padR = 12, padT = 12, padB = 28;
    const W = rect.width, H = rect.height;
    const plotW = W - padL - padR;
    const plotH = H - padT - padB;

    // grid
    ctx.lineWidth = 1;
    ctx.strokeStyle = "rgba(255,255,255,.08)";
    ctx.fillStyle = "rgba(255,255,255,.35)";
    ctx.font = "12px -apple-system,BlinkMacSystemFont,Segoe UI,Roboto";
    for(let j=0;j<=3;j++){
      const y = padT + plotH*(j/3);
      ctx.beginPath(); ctx.moveTo(padL,y); ctx.lineTo(W-padR,y); ctx.stroke();
      const val = maxV - (maxV-minV)*(j/3);
      ctx.fillText(String(Math.round(val)), 10, y+4);
    }
    ctx.strokeStyle = "rgba(255,255,255,.12)";
    ctx.beginPath(); ctx.moveTo(padL,padT+plotH); ctx.lineTo(W-padR,padT+plotH); ctx.stroke();

    const xOf = (k)=> padL + (pointsCount<=1?0:(plotW*(k/(pointsCount-1))));
    const yOf = (v)=> padT + ((maxV - v)/(maxV - minV))*plotH;

    function colorFor(i){
      const hue = (i * 360 / Math.max(1,n));
      return `hsla(${hue}, 80%, 65%, 0.9)`;
    }

    for(let i=0;i<n;i++){
      ctx.strokeStyle = colorFor(i);
      ctx.lineWidth = 2;
      ctx.beginPath();
      for(let k=0;k<pointsCount;k++){
        const x=xOf(k), y=yOf(series[i][k]);
        if(k===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      }
      ctx.stroke();

      const lastX=xOf(pointsCount-1), lastY=yOf(series[i][pointsCount-1]);
      ctx.fillStyle = colorFor(i);
      ctx.beginPath(); ctx.arc(lastX,lastY,3,0,Math.PI*2); ctx.fill();

      // legend
      ctx.fillStyle = colorFor(i);
      ctx.fillRect(W-padR-10, padT + i*18, 10, 10);
      ctx.fillStyle = "rgba(232,238,252,.9)";
      ctx.fillText(state.players[i]||("玩家"+(i+1)), W-padR-10-110, padT + i*18 + 10);
    }

    ctx.fillStyle = "rgba(255,255,255,.45)";
    ctx.fillText("局数 →", W-60, H-10);
  }

  // ---------- Events ----------
  tabHomeBtn.addEventListener("click", ()=>openTab("home"));
  tabEditBtn.addEventListener("click", ()=>openTab("edit"));
  tabSettingsBtn.addEventListener("click", ()=>openTab("settings"));

  btnGoEdit.addEventListener("click", ()=>openTab("edit"));
  btnGoSettings.addEventListener("click", ()=>openTab("settings"));

  btnRefresh.addEventListener("click", ()=>{ rebuildHome(); drawTrendChart(); });

  btnOpenDetails.addEventListener("click", openDrawer);
  btnCloseDetails.addEventListener("click", closeDrawer);
  drawerMask.addEventListener("click", closeDrawer);
  btnDeleteLast.addEventListener("click", deleteLast);

  btnResetAll.addEventListener("click", resetAll);

  btnSaveSettings.addEventListener("click", saveSettings);
  playerCountEl.addEventListener("change", ()=>{
    // 临时预览 settings UI，不落库
    const n = Number(playerCountEl.value);
    const backup = JSON.parse(JSON.stringify(state));
    state.playerCount = n;
    state.players = backup.players.slice(0,n);
    while(state.players.length<n){
      state.players.push(PRESET_NAMES[state.players.length] || ("玩家"+(state.players.length+1)));
    }
    rebuildSettings();
    state = backup;
  });

  btnClearInputs.addEventListener("click", clearInputs);
  btnRequestSave.addEventListener("click", requestSave);

  btnCloseConfirm.addEventListener("click", closeConfirmModal);
  btnCancelSave.addEventListener("click", closeConfirmModal);
  confirmMask.addEventListener("click", (e)=>{ if(e.target===confirmMask) closeConfirmModal(); });
  btnConfirmSave.addEventListener("click", confirmSave);

  window.addEventListener("resize", ()=>{
    clearTimeout(window.__chartT);
    window.__chartT = setTimeout(drawTrendChart, 120);
  });

  // ---------- Init ----------
  // 修正初始
  if(state.playerCount !== 3 && state.playerCount !== 4) state.playerCount = 4;
  if(!Array.isArray(state.players) || state.players.length===0) state.players = PRESET_NAMES.slice();
  state.players = state.players.slice(0, state.playerCount);
  while(state.players.length < state.playerCount){
    state.players.push(PRESET_NAMES[state.players.length] || ("玩家"+(state.players.length+1)));
  }
  saveState();
  rebuildAll();
  clearInputs();
  openTab("home");
})();
</script>

</body>
</html>
