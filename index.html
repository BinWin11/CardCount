<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>
  <title>牌局记账 v3.6（localStorage + 折线图 + 横向条 + 结算 + iPad弹窗强制居中）</title>
  <style>
    :root{
      --bg:#0b1220; --card:#121a2b; --muted:#7f8aa3; --text:#e8eefc;
      --ok:#25c26e; --bad:#ff5c6c; --warn:#ffcc66; --line:rgba(255,255,255,.09);
      --btn:#2a3a63; --btn2:#1c2743; --shadow:0 10px 30px rgba(0,0,0,.35);

      /* ✅ v3.6：弹窗专用配色（与主体区分更明显） */
      --modal-bg: rgba(26, 36, 64, .98);
      --modal-bg2: rgba(20, 28, 52, .98);
      --modal-line: rgba(255,255,255,.14);
      --modal-shadow: 0 22px 70px rgba(0,0,0,.62);
    }
    *{box-sizing:border-box}
    body{
      margin:0; color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"PingFang SC","Microsoft Yahei",sans-serif;
      background:linear-gradient(180deg,#070c16,#0b1220 30%,#070c16);
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    .topbar{
      position:sticky; top:0; z-index:30;
      background:rgba(7,12,22,.75); backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);
    }
    .topbar-inner{
      max-width:1100px;margin:0 auto;padding:10px 14px;
      display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;
    }
    .title{font-weight:900;font-size:16px}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tabbtn{
      border:1px solid var(--line); border-radius:999px;
      padding:8px 12px; cursor:pointer; user-select:none;
      background:rgba(18,26,43,.6);
      font-size:13px;
    }
    .tabbtn.active{background:linear-gradient(180deg,var(--btn),var(--btn2));}
    .actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    button{
      background:linear-gradient(180deg,var(--btn),var(--btn2));
      border:1px solid var(--line);
      color:var(--text); border-radius:12px;
      padding:10px 12px; font-size:14px; cursor:pointer;
      box-shadow:0 8px 18px rgba(0,0,0,.18);
    }
    button:hover{filter:brightness(1.08)}
    .btn-ghost{background:transparent;box-shadow:none}
    .btn-danger{background:linear-gradient(180deg,#5b2230,#3a1620);border-color:rgba(255,92,108,.25)}
    .btn-ok{background:linear-gradient(180deg,#1f5a3b,#143524);border-color:rgba(37,194,110,.25)}

    .wrap{max-width:1100px;margin:0 auto;padding:14px;}
    .grid{display:grid;grid-template-columns:1fr;gap:12px;margin-top:12px;}
    @media (min-width:900px){ .grid{grid-template-columns:1.2fr .8fr;} }

    .card{
      background:rgba(18,26,43,.92);
      border:1px solid var(--line);
      border-radius:14px;
      padding:14px;
      box-shadow:var(--shadow);
    }
    .pill{display:inline-block;padding:3px 8px;border:1px solid var(--line);border-radius:999px;font-size:12px;color:var(--muted)}
    .muted{color:var(--muted);font-size:12px;line-height:1.5}
    .sep{height:1px;background:var(--line);margin:12px 0}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    label{font-size:12px;color:var(--muted)}
    input{
      background:#0d1426;color:var(--text);border:1px solid var(--line);
      border-radius:12px;padding:10px 10px;font-size:15px;outline:none;
    }
    select{
      background:#0d1426;color:var(--text);border:1px solid var(--line);
      border-radius:12px;padding:10px 10px;font-size:15px;outline:none;
      min-width:150px;
    }
    input:focus,select:focus{border-color:rgba(255,255,255,.25)}
    input[type="text"]{min-width:160px}
    .msg{font-size:13px;margin-top:8px}
    .msg.ok{color:var(--ok)} .msg.bad{color:var(--bad)} .msg.warn{color:var(--warn)}

    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--line);padding:12px 8px;text-align:left}
    th{color:var(--muted);font-weight:900;font-size:13px}
    .pos{color:var(--ok)}
    .neg{color:var(--bad)}

    /* 累计看板：人名 + 横向条 + 金额，同一行 */
    .scoreRow{display:flex;align-items:center;gap:12px;flex-wrap:nowrap;}
    .scoreName{
      min-width:120px;font-size:18px;font-weight:1000;letter-spacing:.2px;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    .scoreBarWrap{
      flex:1;height:16px;border:1px solid var(--line);
      background:rgba(0,0,0,.16);border-radius:999px;position:relative;overflow:hidden;
    }
    .scoreBarFill{position:absolute;top:0;bottom:0;border-radius:999px;}
    .scoreAmt{
      min-width:84px;text-align:right;font-size:22px;font-weight:1000;letter-spacing:.3px;white-space:nowrap;
    }
    @media (min-width:900px){
      .scoreName{font-size:20px; min-width:150px;}
      .scoreAmt{font-size:26px; min-width:100px;}
      .scoreBarWrap{height:18px;}
    }

    /* 侧边栏（明细） */
    .drawer-mask{position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:90; display:none;}
    .drawer{
      position:fixed; top:0; right:0; height:100vh;
      width:min(560px, 94vw);
      background:rgba(18,26,43,.98); backdrop-filter: blur(10px);
      border-left:1px solid var(--line);
      z-index:100;
      transform: translateX(110%);
      transition: transform .25s ease;
      display:flex; flex-direction:column;
      box-shadow: -14px 0 40px rgba(0,0,0,.45);
    }
    .drawer.open{transform: translateX(0);}
    .drawer-head{padding:12px 12px;border-bottom:1px solid var(--line);display:flex;gap:10px;align-items:center;justify-content:space-between}
    .drawer-body{padding:12px;overflow:auto;-webkit-overflow-scrolling:touch;}
    details{border:1px solid var(--line);border-radius:12px;padding:10px 10px;margin:10px 0;background:rgba(0,0,0,.14)}
    summary{cursor:pointer;list-style:none}
    summary::-webkit-details-marker{display:none}
    .flex-between{display:flex;justify-content:space-between;gap:10px;align-items:center;flex-wrap:wrap}
    .small{font-size:12px}

    /* 金额输入块 */
    .amt-box{min-width:240px;flex:1}
    .amt-line{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:6px}
    .amt-line input[type="number"]{width:160px}

    /* 快捷按钮（iPad好按） */
    .quickbar{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .chip{
      border:1px solid var(--line);
      border-radius:14px;
      padding:14px 18px;
      font-size:18px;
      font-weight:1000;
      cursor:pointer;
      background:rgba(0,0,0,.14);
      user-select:none;
      min-width:64px;
      text-align:center;
      touch-action: manipulation;
    }
    .chip:active{transform:scale(.98)}
    @media (min-width:768px){
      .chip{
        padding:16px 22px;
        font-size:20px;
        min-width:76px;
        border-radius:16px;
      }
    }

    .badgeWinner{
      display:inline-block; padding:3px 8px; border-radius:999px;
      border:1px solid rgba(37,194,110,.25);
      color:var(--ok); font-size:12px; font-weight:900;
      background:rgba(31,90,59,.25);
      margin-left:6px;
    }

    /* 图表容器 */
    .chartWrap{
      border:1px solid var(--line);
      border-radius:14px;
      background:rgba(0,0,0,.14);
      padding:10px;
    }
    .chartCanvas{width:100%;height:220px;display:block;}
    .chartHint{margin-top:8px;font-size:12px;color:var(--muted);line-height:1.5;}

    /* ✅ v3.6：iPad 弹窗强制居中（visualViewport） + 顶部布局更稳 + 颜色区分更明显 */
    .modal-mask{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.66); /* 更明显的遮罩 */
      z-index:200;
      display:none;
    }
    .modal{
      position:fixed;
      left:50%;
      top: var(--modal-center-top, 50vh);
      transform: translate(-50%, -50%);

      width:min(760px, 96vw);
      max-height: calc(var(--vvh, 100vh) - 24px);

      background: linear-gradient(180deg, var(--modal-bg), var(--modal-bg2));
      border:1px solid var(--modal-line);
      border-radius:18px;
      box-shadow: var(--modal-shadow);
      overflow:hidden;

      display:flex;
      flex-direction:column;
    }

    /* ✅ v3.6：弹窗头部布局修复：对齐、间距、层次 */
    .modal-head{
      flex:0 0 auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;

      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.10);
      backdrop-filter: blur(6px);
    }
    .modal-title-wrap{
      min-width:0;
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .bigTitle{
      font-size:18px;
      font-weight:1000;
      line-height:1.15;
      letter-spacing:.2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .modal-subtitle{
      font-size:12px;
      color:rgba(232,238,252,.62);
      line-height:1.2;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .modal-close{
      flex:0 0 auto;
      border-radius:12px;
      padding:10px 12px;
    }

    .modal-body{
      flex:1 1 auto;
      padding:14px;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      padding-bottom: max(14px, env(safe-area-inset-bottom));
    }

    .tipBox{margin-top:10px;border:1px solid var(--line);border-radius:14px;padding:12px;background:rgba(0,0,0,.14);}
    .list-item{padding:10px 10px;border:1px solid var(--line);border-radius:12px;margin:10px 0;background:rgba(0,0,0,.14);}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
  </style>
</head>

<body>

<div class="topbar">
  <div class="topbar-inner">
    <div class="title">牌局记账 v3.6 <span style="opacity:.6;font-size:12px;">（localStorage）</span></div>

    <div class="tabs">
      <div class="tabbtn active" id="tabHomeBtn">主页</div>
      <div class="tabbtn" id="tabEditBtn">记账</div>
      <div class="tabbtn" id="tabSettingsBtn">设置</div>
    </div>

    <div class="actions">
      <button class="btn-ok" id="btnGoEditTop">去记一局</button>
      <button class="btn-ghost" id="btnOpenDetails">明细侧边栏</button>
    </div>
  </div>
</div>

<div class="wrap">
  <!-- HOME -->
  <div id="tabHome">
    <div class="grid">
      <div class="card">
        <div class="flex-between">
          <div>
            <div class="pill">累计看板</div>
            <div class="muted" id="metaInfo" style="margin-top:6px;"></div>
          </div>
          <div class="row">
            <button class="btn-ghost" id="btnRefresh">刷新</button>
            <button class="btn-ok" id="btnOpenSettle">结算分账</button>
          </div>
        </div>

        <div class="sep"></div>

        <table>
          <thead><tr><th>玩家 &amp; 横向条</th></tr></thead>
          <tbody id="scoreboardBody"></tbody>
        </table>

        <div class="sep"></div>

        <div class="chartWrap">
          <div class="pill">累计走势折线图</div>
          <div style="height:8px;"></div>
          <canvas id="lineChart" class="chartCanvas"></canvas>
          <div class="chartHint">折线图：X=局数（从第1局开始），Y=累计输赢金额。</div>
        </div>

        <div class="sep"></div>
        <div class="muted">说明：累计为正=赢；累计为负=输。横向条：正数绿色从左起，负数红色从右起。</div>
      </div>

      <div class="card">
        <div class="pill">快捷操作</div>
        <div class="sep"></div>
        <div class="row">
          <button class="btn-ghost" id="btnGoSettings">去设置</button>
          <button class="btn-danger" id="btnResetAll">清空全部（多次确认）</button>
        </div>
        <div class="sep"></div>
        <div class="pill">规则提示</div>
        <div class="muted" style="margin-top:8px;">
          - 选择胜利者后：胜者为正，其余为负（你输入的是绝对值）。<br/>
          - 保存会弹确认弹窗（iPad 已强制居中）。<br/>
          - 每局合计必须为 0 才能保存（胜者赢的钱=其他人输的钱之和）。
        </div>
      </div>
    </div>
  </div>

  <!-- EDIT -->
  <div id="tabEdit" style="display:none;">
    <div class="card">
      <div class="flex-between">
        <div>
          <div class="pill">记一局（自动正负）</div>
          <div class="muted" style="margin-top:6px;">
            金额支持：手动输入、快捷按钮（仅正数）。当非胜利者都填完，会自动算出胜利者金额。
          </div>
        </div>
        <div class="row">
          <button class="btn-ghost" id="btnClearInputs">清空本局输入</button>
        </div>
      </div>

      <div class="sep"></div>

      <div class="row">
        <div>
          <label>人数</label><br/>
          <select id="playerCountReadOnly" disabled></select>
        </div>

        <div>
          <label>胜利者</label><br/>
          <select id="winnerSelect"></select>
        </div>

        <button class="btn-ghost" id="btnAutoFillWinner">自动让胜者 = 其余合计</button>
      </div>

      <div id="amountInputsBox" class="row" style="margin-top:12px;"></div>
      <div id="sumMsg" class="msg"></div>

      <div class="sep"></div>
      <div class="row">
        <button class="btn-ok" id="btnRequestSave">保存（先确认）</button>
        <span class="muted">保存会写入 localStorage</span>
      </div>
    </div>
  </div>

  <!-- SETTINGS -->
  <div id="tabSettings" style="display:none;">
    <div class="card">
      <div class="pill">基础设置</div>
      <div class="muted" style="margin-top:6px;">默认姓名支持选择：陈彬、黄晓芹、黄晓燕、谢绵令；也支持自定义输入。</div>

      <div class="sep"></div>

      <div class="row">
        <div>
          <label>人数</label><br/>
          <select id="playerCount">
            <option value="4">4 人</option>
            <option value="3">3 人</option>
            <option value="2">2 人</option>
          </select>
        </div>
        <div class="muted">切换人数后，下面只显示对应人数的姓名配置。</div>
      </div>

      <div class="sep"></div>

      <div id="playerNamesBox" class="row"></div>

      <div class="row" style="margin-top:10px;">
        <button id="btnSaveSettings">保存设置</button>
      </div>

      <div class="sep"></div>
      <div class="muted">提醒：切换人数后历史局数据仍保留，但展示/计算按当前人数对应位置取值。</div>
    </div>
  </div>
</div>

<!-- 明细侧边栏 -->
<div class="drawer-mask" id="drawerMask"></div>
<div class="drawer" id="drawer">
  <div class="drawer-head">
    <div>
      <div style="font-weight:1000">局数明细</div>
      <div class="muted small" id="drawerMeta"></div>
    </div>
    <div class="row">
      <button class="btn-ghost" id="btnCloseDetails">关闭</button>
    </div>
  </div>
  <div class="drawer-body">
    <div class="row">
      <button class="btn-ghost" id="btnDeleteLast">删除最后一局</button>
    </div>
    <div id="roundsBox" style="margin-top:10px;"></div>
  </div>
</div>

<!-- 无数据引导弹窗 -->
<div class="modal-mask" id="emptyMask" aria-modal="true" role="dialog">
  <div class="modal">
    <div class="modal-head">
      <div class="modal-title-wrap">
        <div class="bigTitle">还没有数据，先去设置一下吧</div>
        <div class="modal-subtitle">建议先配置人数和玩家姓名，再开始记账</div>
      </div>
      <button class="btn-ghost modal-close" id="btnCloseEmpty">关闭</button>
    </div>
    <div class="modal-body">
      <div class="muted">当前没有任何牌局记录。建议先完成「人数/玩家姓名」基础设置，再开始记账。</div>
      <div class="tipBox">
        <div style="font-weight:900;">你可以这样做：</div>
        <div class="muted" style="margin-top:8px; line-height:1.7;">
          1）去设置人数（2/3/4）和玩家姓名；<br/>
          2）回到记账选择胜利者，输入金额；<br/>
          3）非胜利者填完后系统自动算胜利者，再保存。
        </div>
      </div>
      <div class="sep"></div>
      <div class="row">
        <button class="btn-ok" id="btnGoSettingsFromEmpty">去设置</button>
        <button class="btn-ghost" id="btnGoEditFromEmpty">直接去记账</button>
      </div>
    </div>
  </div>
</div>

<!-- 记账确认弹窗 -->
<div class="modal-mask" id="confirmMask" aria-modal="true" role="dialog">
  <div class="modal">
    <div class="modal-head">
      <div class="modal-title-wrap">
        <div class="bigTitle">确认保存本局？</div>
        <div class="modal-subtitle">请核对本局金额（系统已自动加/减号）</div>
      </div>
      <button class="btn-ghost modal-close" id="btnCloseConfirm">关闭</button>
    </div>
    <div class="modal-body">
      <div class="muted">以下为本局最终金额：</div>
      <div class="sep"></div>
      <div id="confirmList"></div>
      <div class="sep"></div>
      <div id="confirmSum" class="muted"></div>
      <div class="sep"></div>
      <div class="row">
        <button class="btn-ok" id="btnConfirmSave">确认保存</button>
        <button class="btn-ghost" id="btnCancelSave">取消</button>
      </div>
    </div>
  </div>
</div>

<!-- 结算分账弹窗 -->
<div class="modal-mask" id="settleMask" aria-modal="true" role="dialog">
  <div class="modal">
    <div class="modal-head">
      <div class="modal-title-wrap">
        <div class="bigTitle">结算分账（转账建议）</div>
        <div class="modal-subtitle">优先撮合：陈彬↔黄晓芹，谢绵令↔黄晓燕</div>
      </div>
      <button class="btn-ghost modal-close" id="btnCloseSettle">关闭</button>
    </div>
    <div class="modal-body">
      <div class="muted">
        规则：累计为负的人需要付钱；累计为正的人收钱。
      </div>
      <div class="sep"></div>
      <div id="settleList"></div>
      <div class="sep"></div>
      <div class="row">
        <button class="btn-ghost" id="btnCopySettle">复制转账文本</button>
      </div>
      <div class="muted" style="margin-top:10px;">注：若有人累计为 0，则无需转账。</div>
    </div>
  </div>
</div>

<script>
(function(){
  const STORE_KEY = "POKER_MONEY_V3_6_LS";
  const PRESET_NAMES = ["陈彬","黄晓芹","黄晓燕","谢绵令"];

  // ---------- localStorage ----------
  function loadState(){
    const raw = localStorage.getItem(STORE_KEY);
    if(!raw) return defaultState();
    try{
      const obj = JSON.parse(raw);
      if(!obj || !Array.isArray(obj.players) || !Array.isArray(obj.rounds)) return defaultState();
      if(![2,3,4].includes(obj.playerCount)) obj.playerCount = obj.players.length || 4;
      if(!obj.meta) obj.meta = {};
      return obj;
    }catch(e){
      return defaultState();
    }
  }
  function saveState(){
    localStorage.setItem(STORE_KEY, JSON.stringify(state));
  }
  function clearStorage(){
    localStorage.removeItem(STORE_KEY);
  }

  // ---------- State ----------
  function defaultState(){
    return {
      playerCount: 4,
      players: ["陈彬","黄晓芹","黄晓燕","谢绵令"],
      rounds: [],
      meta: { emptyGuideShownOnce: false }
    };
  }

  let state = loadState();

  // ---------- DOM ----------
  const $ = (id)=>document.getElementById(id);

  // Tabs
  const tabHomeBtn = $("tabHomeBtn");
  const tabEditBtn = $("tabEditBtn");
  const tabSettingsBtn = $("tabSettingsBtn");
  const tabHome = $("tabHome");
  const tabEdit = $("tabEdit");
  const tabSettings = $("tabSettings");

  // Top actions
  const btnGoEditTop = $("btnGoEditTop");
  const btnOpenDetails = $("btnOpenDetails");

  // Home
  const metaInfo = $("metaInfo");
  const scoreboardBody = $("scoreboardBody");
  const btnGoSettings = $("btnGoSettings");
  const btnResetAll = $("btnResetAll");
  const btnRefresh = $("btnRefresh");
  const btnOpenSettle = $("btnOpenSettle");

  // Line chart
  const lineChart = $("lineChart");

  // Settings
  const playerCountEl = $("playerCount");
  const playerNamesBox = $("playerNamesBox");
  const btnSaveSettings = $("btnSaveSettings");

  // Edit
  const playerCountReadOnly = $("playerCountReadOnly");
  const winnerSelect = $("winnerSelect");
  const amountInputsBox = $("amountInputsBox");
  const sumMsg = $("sumMsg");
  const btnClearInputs = $("btnClearInputs");
  const btnRequestSave = $("btnRequestSave");
  const btnAutoFillWinner = $("btnAutoFillWinner");

  // Drawer
  const drawer = $("drawer");
  const drawerMask = $("drawerMask");
  const btnCloseDetails = $("btnCloseDetails");
  const roundsBox = $("roundsBox");
  const drawerMeta = $("drawerMeta");
  const btnDeleteLast = $("btnDeleteLast");

  // Empty modal
  const emptyMask = $("emptyMask");
  const btnCloseEmpty = $("btnCloseEmpty");
  const btnGoSettingsFromEmpty = $("btnGoSettingsFromEmpty");
  const btnGoEditFromEmpty = $("btnGoEditFromEmpty");

  // Confirm modal
  const confirmMask = $("confirmMask");
  const btnCloseConfirm = $("btnCloseConfirm");
  const btnCancelSave = $("btnCancelSave");
  const btnConfirmSave = $("btnConfirmSave");
  const confirmList = $("confirmList");
  const confirmSum = $("confirmSum");

  // Settle modal
  const settleMask = $("settleMask");
  const btnCloseSettle = $("btnCloseSettle");
  const settleList = $("settleList");
  const btnCopySettle = $("btnCopySettle");

  // pending for confirm
  let pendingSigned = null;
  let pendingWinner = null;

  function escapeHtml(str){
    return String(str).replace(/[&<>"']/g, s=>({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[s]));
  }
  function showSumMsg(type, text){
    sumMsg.className = "msg " + (type||"");
    sumMsg.textContent = text || "";
  }

  function openTab(name){
    const isHome = name==="home";
    const isEdit = name==="edit";
    const isSettings = name==="settings";
    tabHome.style.display = isHome ? "" : "none";
    tabEdit.style.display = isEdit ? "" : "none";
    tabSettings.style.display = isSettings ? "" : "none";
    tabHomeBtn.classList.toggle("active", isHome);
    tabEditBtn.classList.toggle("active", isEdit);
    tabSettingsBtn.classList.toggle("active", isSettings);

    if(isHome){
      requestAnimationFrame(drawLineChart);
    }
  }

  // ---------- ✅ v3.6：iPad 关键修复：visualViewport 强制居中 ----------
  function updateViewportVars(){
    const vv = window.visualViewport;
    const h = vv ? vv.height : window.innerHeight;
    const topOffset = vv ? vv.offsetTop : 0;
    document.documentElement.style.setProperty("--vvh", h + "px");
    document.documentElement.style.setProperty("--modal-center-top", (topOffset + h/2) + "px");
  }
  function showModal(maskEl){
    updateViewportVars();
    maskEl.style.display = "block";
  }
  function hideModal(maskEl){
    maskEl.style.display = "none";
  }
  updateViewportVars();
  window.addEventListener("resize", updateViewportVars);
  if (window.visualViewport){
    window.visualViewport.addEventListener("resize", updateViewportVars);
    window.visualViewport.addEventListener("scroll", updateViewportVars);
  }

  // ---------- Empty guide modal ----------
  function openEmptyModal(){ showModal(emptyMask); }
  function closeEmptyModal(){ hideModal(emptyMask); }

  function maybeAutoShowEmptyGuide(reason){
    const hasRounds = (state.rounds?.length || 0) > 0;
    if(hasRounds){
      closeEmptyModal();
      return;
    }
    if(reason === "reset"){
      state.meta.emptyGuideShownOnce = false;
      saveState();
      openEmptyModal();
      return;
    }
    if(!state.meta.emptyGuideShownOnce){
      state.meta.emptyGuideShownOnce = true;
      saveState();
      openEmptyModal();
    }
  }

  // ---------- Compute ----------
  function normalizePlayers(){
    if(!Array.isArray(state.players)) state.players = PRESET_NAMES.slice();
    state.players = state.players.slice(0, state.playerCount);
    while(state.players.length < state.playerCount){
      state.players.push(PRESET_NAMES[state.players.length] || ("玩家"+(state.players.length+1)));
    }
  }

  function computeTotals(){
    const n = state.playerCount;
    const totals = new Array(n).fill(0);
    for(const r of state.rounds){
      const am = Array.isArray(r.amounts) ? r.amounts : [];
      for(let i=0;i<n;i++) totals[i] += Number(am[i]||0);
    }
    return totals;
  }

  function computeCumulativeSeries(){
    const n = state.playerCount;
    const rounds = [...(state.rounds||[])].sort((a,b)=>a.ts-b.ts);
    const series = Array.from({length:n}, ()=>[]);
    const running = new Array(n).fill(0);
    for(const r of rounds){
      for(let i=0;i<n;i++){
        running[i] += Number((r.amounts||[])[i]||0);
      }
      for(let i=0;i<n;i++){
        series[i].push(running[i]);
      }
    }
    return { rounds, series };
  }

  // 4人局快捷：仅 1/2/3（不出现6和0）
  function quickChipsHtml(i){
	  const n = state.playerCount;
	  let values;

	  if (n === 4){
		values = [1, 2, 3];
	  } else if (n === 3){
		values = [1, 2, 3];
	  } else if (n === 2){
		values = [1, 2, 3, 4];
	  } else {
		// 兜底（理论上不会走到）
		values = [1, 2, 3, 6, 0];
	  }

	  return `
		<div class="quickbar">
		  ${values.map(v=>`<div class="chip" data-idx="${i}" data-v="${v}">${v}</div>`).join("")}
		</div>
	  `;
	}


  function getAbsValue(i){
    const inp = $("amtInp_"+i);
    let v = "";
    if(inp && inp.value !== "") v = inp.value;
    if(v === "") return null;
    const num = Math.abs(Number(v));
    if(!Number.isFinite(num)) return null;
    return num;
  }

  function setAbsValue(i, val, silent){
    const inp = $("amtInp_"+i);
    const abs = Math.abs(Number(val||0));
    if(inp) inp.value = String(abs);
    if(!silent) validateAndPreview(true);
  }

  // 自动计算胜利者：当非胜利者都填完 -> winner = sum(others)
  function maybeAutoCalcWinner(){
    const n = state.playerCount;
    const win = Number(winnerSelect.value);
    if(win < 0 || win >= n) return;

    let allLosersFilled = true;
    let sumLosers = 0;
    for(let i=0;i<n;i++){
      if(i===win) continue;
      const abs = getAbsValue(i);
      if(abs === null){
        allLosersFilled = false;
      }else{
        sumLosers += abs;
      }
    }
    if(allLosersFilled){
      setAbsValue(win, sumLosers, true);
    }
  }

  function validateAndPreview(autoCalc){
    const n = state.playerCount;
    const win = Number(winnerSelect.value);
    if(win < 0 || win >= n){
      showSumMsg("warn","请选择胜利者。");
      return { ok:false };
    }

    if(autoCalc) maybeAutoCalcWinner();

    const signed = new Array(n).fill(0);
    let filled = 0;
    for(let i=0;i<n;i++){
      const abs = getAbsValue(i);
      if(abs === null){
        signed[i] = 0;
        continue;
      }
      filled++;
      signed[i] = (i === win) ? abs : -abs;
    }

    if(filled === 0){
      showSumMsg("warn","请填写金额（手动/快捷均可）。");
      return { ok:false };
    }

    const sum = signed.reduce((a,b)=>a+b,0);
    if(Math.abs(sum) < 1e-9){
      showSumMsg("ok","合计为 0，可以保存（会弹确认）。");
      return { ok:true, signed, sum };
    }else{
      showSumMsg("bad",`合计为 ${sum}（必须为 0 才能保存）。`);
      return { ok:false, signed, sum };
    }
  }

  function autoFillWinner(){
    const n = state.playerCount;
    const win = Number(winnerSelect.value);
    if(win < 0 || win >= n){
      alert("请先选择胜利者。");
      return;
    }
    let loseSum = 0;
    for(let i=0;i<n;i++){
      if(i===win) continue;
      const abs = getAbsValue(i);
      loseSum += Number(abs||0);
    }
    setAbsValue(win, loseSum);
    validateAndPreview(false);
  }

  // ---------- Confirm save modal ----------
  function openConfirmModal(signed, sum){
    confirmList.innerHTML = "";
    for(let i=0;i<state.playerCount;i++){
      const v = signed[i];
      const item = document.createElement("div");
      item.className = "list-item";
      item.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;">
          <div style="font-weight:1000;">${escapeHtml(state.players[i]||("玩家"+(i+1)))}</div>
          <div class="${v>=0?"pos":"neg"}" style="font-size:18px;font-weight:1000;">${v>=0?"+":""}${v}</div>
        </div>
      `;
      confirmList.appendChild(item);
    }
    confirmSum.innerHTML = `本局合计：<b class="${Math.abs(sum)<1e-9?'pos':'neg'}">${sum}</b>（必须为 0）`;
    showModal(confirmMask);
  }
  function closeConfirmModal(){ hideModal(confirmMask); }

  function requestSave(){
    const res = validateAndPreview(true);
    if(!res.ok) return;
    pendingSigned = res.signed;
    pendingWinner = Number(winnerSelect.value);
    openConfirmModal(res.signed, res.sum);
  }

  function confirmSave(){
    if(!pendingSigned) return;

    state.rounds.push({
      id: "R" + Date.now().toString(36) + Math.random().toString(36).slice(2,6),
      ts: Date.now(),
      winnerIndex: pendingWinner,
      amounts: pendingSigned.slice()
    });

    saveState();
    closeEmptyModal();

    pendingSigned = null;
    pendingWinner = null;
    closeConfirmModal();

    rebuildHome();
    rebuildDrawer();
    clearInputs();

    requestAnimationFrame(drawLineChart);
    alert("已保存本局。");
  }

  // ---------- UI Builders ----------
  function rebuildHome(){
    const totals = computeTotals();
    scoreboardBody.innerHTML = "";

    const maxAbs = Math.max(1, ...totals.map(v=>Math.abs(Number(v||0))));

    for(let i=0;i<state.playerCount;i++){
      const name = state.players[i] || ("玩家"+(i+1));
      const val = Number(totals[i]||0);
      const abs = Math.abs(val);
      const pct = Math.min(100, (abs / maxAbs) * 100);

      const fillStyle = val >= 0
        ? `left:0; width:${pct}%; background:rgba(37,194,110,.70);`
        : `right:0; width:${pct}%; background:rgba(255,92,108,.70);`;

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>
          <div class="scoreRow">
            <div class="scoreName">${escapeHtml(name)}</div>
            <div class="scoreBarWrap">
              <div class="scoreBarFill" style="${fillStyle}"></div>
            </div>
            <div class="scoreAmt ${val>=0?'pos':'neg'}">${val>=0?"+":""}${val}</div>
          </div>
        </td>
      `;
      scoreboardBody.appendChild(tr);
    }

    metaInfo.textContent = `人数：${state.playerCount}；局数：${state.rounds.length}`;
  }

  function rebuildSettings(){
    playerCountEl.value = String(state.playerCount);
    playerNamesBox.innerHTML = "";
    const n = state.playerCount;

    for(let i=0;i<n;i++){
      const current = state.players[i] || "";
      const isPreset = PRESET_NAMES.includes(current);
      const wrap = document.createElement("div");
      wrap.style.minWidth = "260px";
      wrap.innerHTML = `
        <label>玩家 ${i+1}</label><br/>
        <div class="amt-line">
          <select id="nameSel_${i}">
            <option value="">请选择</option>
            ${PRESET_NAMES.map(nm=>`<option value="${escapeHtml(nm)}"${nm===current?" selected":""}>${escapeHtml(nm)}</option>`).join("")}
            <option value="__custom__"${isPreset ? "" : " selected"}>自定义</option>
          </select>
          <input type="text" id="nameCustom_${i}" placeholder="自定义姓名"
                 value="${isPreset ? "" : escapeHtml(current)}" ${isPreset ? "disabled":""}/>
        </div>
        <div class="muted">选择默认姓名或切到“自定义”输入</div>
      `;
      playerNamesBox.appendChild(wrap);
    }

    for(let i=0;i<n;i++){
      $("nameSel_"+i).addEventListener("change", ()=>{
        const selV = $("nameSel_"+i).value;
        const inp = $("nameCustom_"+i);
        if(selV === "__custom__"){
          inp.disabled = false;
          inp.focus();
        }else{
          inp.value = "";
          inp.disabled = true;
        }
      });
    }
  }

  function rebuildEdit(){
    playerCountReadOnly.innerHTML = `<option>${state.playerCount} 人</option>`;

    winnerSelect.innerHTML = `<option value="-1">请选择胜利者</option>`;
    for(let i=0;i<state.playerCount;i++){
      const opt = document.createElement("option");
      opt.value = String(i);
      opt.textContent = state.players[i] || ("玩家"+(i+1));
      winnerSelect.appendChild(opt);
    }

    amountInputsBox.innerHTML = "";
    const n = state.playerCount;

    for(let i=0;i<n;i++){
      const name = state.players[i] || ("玩家"+(i+1));
      const box = document.createElement("div");
      box.className = "amt-box";
      box.innerHTML = `
        <label>${escapeHtml(name)} <span id="winnerTag_${i}"></span></label>
        <div class="amt-line">
          <input type="number" id="amtInp_${i}" inputmode="numeric" min="0" step="1" placeholder="输入金额（正数）" />
        </div>
        ${quickChipsHtml(i)}
        <div class="muted">输入绝对值；系统按胜利者自动判断正负。非胜利者填完会自动计算胜利者。</div>
      `;
      amountInputsBox.appendChild(box);
    }

    amountInputsBox.querySelectorAll(".chip").forEach(chip=>{
      chip.addEventListener("click", ()=>{
        const idx = Number(chip.getAttribute("data-idx"));
        const v = Number(chip.getAttribute("data-v"));
        setAbsValue(idx, v);
      });
    });

    for(let i=0;i<n;i++){
      $("amtInp_"+i).addEventListener("input", ()=>{
        validateAndPreview(true);
      });
    }

    winnerSelect.addEventListener("change", ()=>{
      for(let i=0;i<n;i++) $("winnerTag_"+i).innerHTML = "";
      const win = Number(winnerSelect.value);
      if(win >= 0 && win < n){
        $("winnerTag_"+win).innerHTML = `<span class="badgeWinner">胜利者</span>`;
      }
      validateAndPreview(true);
    });

    showSumMsg("warn","请选择胜利者并填写金额。");
  }

  function rebuildDrawer(){
    drawerMeta.textContent = `共 ${state.rounds.length} 局（最新在上）`;
    roundsBox.innerHTML = "";
    if(state.rounds.length === 0){
      roundsBox.innerHTML = `<div class="muted">暂无记录。</div>`;
      return;
    }

    const n = state.playerCount;
    const rounds = [...state.rounds].sort((a,b)=>b.ts-a.ts);
    for(const r of rounds){
      const idx = state.rounds.findIndex(x=>x.id===r.id);
      const dt = new Date(r.ts);
      const tsStr = dt.toLocaleString();
      const sum = (r.amounts||[]).slice(0,n).reduce((a,b)=>a+Number(b||0),0);
      const sumOk = Math.abs(sum) < 1e-9;

      const detailRows = (r.amounts||[]).slice(0,n).map((v,i)=>{
        const num = Number(v||0);
        return `<tr><td>${escapeHtml(state.players[i]||("玩家"+(i+1)))}</td>
                <td class="${num>=0?"pos":"neg"}" style="font-weight:900;font-size:16px;">${num>=0?"+":""}${num}</td></tr>`;
      }).join("");

      const box = document.createElement("details");
      box.innerHTML = `
        <summary class="flex-between">
          <div>
            <div class="${sumOk?"pos":"neg"}" style="font-weight:1000">
              第 ${idx+1} 局 · ${tsStr} · 合计 ${sumOk?"0":"≠0"}
            </div>
            <div class="muted small">ID：${r.id}</div>
          </div>
          <div class="row">
            <button class="btn-danger" data-del="${r.id}" type="button">删除</button>
          </div>
        </summary>
        <div style="margin-top:10px;">
          <table>
            <thead><tr><th>玩家</th><th>本局</th></tr></thead>
            <tbody>${detailRows}</tbody>
          </table>
        </div>
      `;
      roundsBox.appendChild(box);
    }

    roundsBox.querySelectorAll("button[data-del]").forEach(btn=>{
      btn.addEventListener("click",(e)=>{
        e.preventDefault();
        const id = btn.getAttribute("data-del");
        deleteRound(id);
      });
    });
  }

  function rebuildAll(reasonForEmptyGuide){
    normalizePlayers();
    rebuildHome();
    rebuildSettings();
    rebuildEdit();
    rebuildDrawer();
    requestAnimationFrame(drawLineChart);
    if(reasonForEmptyGuide) maybeAutoShowEmptyGuide(reasonForEmptyGuide);
  }

  function clearInputs(){
    winnerSelect.value = "-1";
    for(let i=0;i<state.playerCount;i++){
      const inp = $("amtInp_"+i);
      if(inp) inp.value = "";
      const tag = $("winnerTag_"+i);
      if(tag) tag.innerHTML = "";
    }
    showSumMsg("warn","请选择胜利者并填写金额。");
  }

  // ---------- Settings save ----------
  function saveSettings(){
    const n = Number(playerCountEl.value);
    state.playerCount = n;

    const players = [];
    for(let i=0;i<n;i++){
      const selV = $("nameSel_"+i)?.value || "";
      const customV = ($("nameCustom_"+i)?.value || "").trim();
      if(selV && selV !== "__custom__") players.push(selV);
      else players.push(customV || ("玩家"+(i+1)));
    }
    state.players = players;

    saveState();
    rebuildAll();
    alert("设置已保存。");
  }

  // ---------- Drawer ----------
  function openDrawer(){
    drawerMask.style.display = "block";
    drawer.classList.add("open");
  }
  function closeDrawer(){
    drawerMask.style.display = "none";
    drawer.classList.remove("open");
  }

  // ---------- Delete / Reset ----------
  function deleteRound(id){
    const idx = state.rounds.findIndex(r=>r.id===id);
    if(idx < 0) return;
    if(!confirm("确定删除该局吗？")) return;
    state.rounds.splice(idx,1);
    saveState();
    rebuildAll();
  }
  function deleteLast(){
    if(state.rounds.length===0) return;
    const idx = state.rounds.length-1;
    if(!confirm(`确定删除最后一局（第 ${idx+1} 局）吗？`)) return;
    state.rounds.splice(idx,1);
    saveState();
    rebuildAll();
  }
  function resetAll(){
    if(!confirm("第 1 次确认：确定清空全部数据吗？")) return;
    if(!confirm("第 2 次确认：清空后不可恢复，确定吗？")) return;
    if(!confirm("第 3 次确认：最后确认，真的要清空吗？")) return;

    clearStorage();
    state = defaultState();
    saveState();

    rebuildAll("reset");
    clearInputs();
    alert("已清空。");
  }

  // ---------- Line chart ----------
  function resizeCanvasToDisplaySize(canvas){
    const rect = canvas.getBoundingClientRect();
    const dpr = window.devicePixelRatio || 1;
    const w = Math.max(1, Math.floor(rect.width * dpr));
    const h = Math.max(1, Math.floor(rect.height * dpr));
    if(canvas.width !== w || canvas.height !== h){
      canvas.width = w;
      canvas.height = h;
      return true;
    }
    return false;
  }

  function drawLineChart(){
    if(!lineChart) return;
    resizeCanvasToDisplaySize(lineChart);
    const ctx = lineChart.getContext("2d");
    const w = lineChart.width, h = lineChart.height;
    ctx.clearRect(0,0,w,h);

    const { series } = computeCumulativeSeries();
    const n = state.playerCount;
    const m = (series[0]||[]).length;

    if(m === 0){
      ctx.fillStyle = "rgba(255,255,255,.55)";
      ctx.font = `${Math.floor(14*(window.devicePixelRatio||1))}px -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto`;
      ctx.fillText("暂无折线数据（先记一局）", Math.floor(w*0.08), Math.floor(h*0.55));
      return;
    }

    const padding = Math.floor(Math.min(w,h) * 0.10);
    const innerW = w - padding*2;
    const innerH = h - padding*2;

    let minY = Infinity, maxY = -Infinity;
    for(let i=0;i<n;i++){
      for(const v of series[i]){
        minY = Math.min(minY, v);
        maxY = Math.max(maxY, v);
      }
    }
    const range = Math.max(1, maxY - minY);
    minY = minY - range*0.1;
    maxY = maxY + range*0.1;

    function xAt(k){
      if(m<=1) return padding + innerW/2;
      return padding + (k/(m-1))*innerW;
    }
    function yAt(v){
      const t = (v - minY) / (maxY - minY || 1);
      return padding + (1-t)*innerH;
    }

    ctx.strokeStyle = "rgba(255,255,255,.10)";
    ctx.lineWidth = Math.max(1, Math.floor((window.devicePixelRatio||1)));
    const gridN = 4;
    for(let g=0; g<=gridN; g++){
      const y = padding + (g/gridN)*innerH;
      ctx.beginPath();
      ctx.moveTo(padding, y);
      ctx.lineTo(padding+innerW, y);
      ctx.stroke();
    }

    ctx.fillStyle = "rgba(255,255,255,.55)";
    ctx.font = `${Math.floor(11*(window.devicePixelRatio||1))}px -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto`;
    ctx.fillText(`第1局`, padding, padding-6);
    ctx.fillText(`第${m}局`, padding+innerW-40, padding-6);

    const colors = [
      "rgba(86,160,255,.95)",
      "rgba(255,204,102,.95)",
      "rgba(37,194,110,.95)",
      "rgba(255,92,108,.95)"
    ];

    for(let i=0;i<n;i++){
      const arr = series[i];
      ctx.strokeStyle = colors[i % colors.length];
      ctx.lineWidth = Math.max(2, Math.floor(2*(window.devicePixelRatio||1)));
      ctx.beginPath();
      for(let k=0;k<m;k++){
        const x = xAt(k);
        const y = yAt(arr[k]);
        if(k===0) ctx.moveTo(x,y);
        else ctx.lineTo(x,y);
      }
      ctx.stroke();

      const xLast = xAt(m-1), yLast = yAt(arr[m-1]);
      ctx.fillStyle = colors[i % colors.length];
      ctx.beginPath();
      ctx.arc(xLast, yLast, Math.max(3, Math.floor(3*(window.devicePixelRatio||1))), 0, Math.PI*2);
      ctx.fill();
    }
  }

  // ---------- Settlement ----------
  function openSettleModal(){
    const totals = computeTotals();
    const names = state.players.slice(0,state.playerCount);
    const transfers = generateTransfersWithPriority(names, totals);

    settleList.innerHTML = "";
    if(transfers.length === 0){
      settleList.innerHTML = `<div class="muted">当前无需转账（所有人累计均为 0）。</div>`;
    }else{
      transfers.forEach(t=>{
        const item = document.createElement("div");
        item.className = "list-item";
        item.innerHTML = `
          <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center;">
            <div style="font-weight:1000;">${escapeHtml(t.from)} → ${escapeHtml(t.to)}</div>
            <div class="mono" style="font-weight:1000;font-size:16px;">¥ ${t.amount}</div>
          </div>
        `;
        settleList.appendChild(item);
      });
    }
    showModal(settleMask);
  }
  function closeSettleModal(){ hideModal(settleMask); }

  function generateTransfersWithPriority(names, totals){
    const n = names.length;
    const payers = [];
    const receivers = [];
    for(let i=0;i<n;i++){
      const v = Number(totals[i]||0);
      if(v < 0) payers.push({i, remain: -v});
      else if(v > 0) receivers.push({i, remain: v});
    }

    const transfers = [];

    function getPayer(i){ return payers.find(p=>p.i===i && p.remain>0); }
    function getRecv(i){ return receivers.find(r=>r.i===i && r.remain>0); }

    function matchOneToOne(payerIdx, recvIdx){
      const p = getPayer(payerIdx);
      const r = getRecv(recvIdx);
      if(!p || !r) return;
      const amt = Math.min(p.remain, r.remain);
      if(amt <= 0) return;
      p.remain -= amt;
      r.remain -= amt;
      transfers.push({from: names[payerIdx], to: names[recvIdx], amount: amt});
    }

    function settlePair(aName, bName){
      const a = names.indexOf(aName);
      const b = names.indexOf(bName);
      if(a<0 || b<0) return;
      matchOneToOne(a, b);
      matchOneToOne(b, a);
    }

    settlePair("陈彬","黄晓芹");
    settlePair("谢绵令","黄晓燕");

    payers.sort((a,b)=>b.remain-a.remain);
    receivers.sort((a,b)=>b.remain-a.remain);

    let pi = 0, ri = 0;
    while(pi < payers.length && ri < receivers.length){
      const p = payers[pi];
      const r = receivers[ri];
      if(p.remain<=0){ pi++; continue; }
      if(r.remain<=0){ ri++; continue; }
      const amt = Math.min(p.remain, r.remain);
      p.remain -= amt;
      r.remain -= amt;
      transfers.push({from:names[p.i], to:names[r.i], amount: amt});
    }

    return transfers;
  }

  function buildSettleText(){
    const totals = computeTotals();
    const names = state.players.slice(0,state.playerCount);
    const transfers = generateTransfersWithPriority(names, totals);
    if(transfers.length===0) return "无需转账（所有人累计均为0）";
    return transfers.map(t=>`${t.from} -> ${t.to} : ¥${t.amount}`).join("\n");
  }

  // ---------- Bind Events ----------
  tabHomeBtn.addEventListener("click", ()=>openTab("home"));
  tabEditBtn.addEventListener("click", ()=>openTab("edit"));
  tabSettingsBtn.addEventListener("click", ()=>openTab("settings"));

  btnGoEditTop.addEventListener("click", ()=>openTab("edit"));
  btnGoSettings.addEventListener("click", ()=>openTab("settings"));
  btnRefresh.addEventListener("click", ()=>{
    rebuildHome();
    drawLineChart();
  });

  btnOpenDetails.addEventListener("click", openDrawer);
  btnCloseDetails.addEventListener("click", closeDrawer);
  drawerMask.addEventListener("click", closeDrawer);

  btnDeleteLast.addEventListener("click", deleteLast);
  btnResetAll.addEventListener("click", resetAll);

  btnSaveSettings.addEventListener("click", saveSettings);
  playerCountEl.addEventListener("change", ()=>{
    const n = Number(playerCountEl.value);
    const backup = JSON.parse(JSON.stringify(state));
    state.playerCount = n;
    state.players = backup.players.slice(0,n);
    while(state.players.length<n){
      state.players.push(PRESET_NAMES[state.players.length] || ("玩家"+(state.players.length+1)));
    }
    rebuildSettings();
    state = backup;
  });

  btnClearInputs.addEventListener("click", clearInputs);
  btnRequestSave.addEventListener("click", requestSave);
  btnAutoFillWinner.addEventListener("click", autoFillWinner);

  // Empty modal buttons
  btnCloseEmpty.addEventListener("click", closeEmptyModal);
  emptyMask.addEventListener("click", (e)=>{ if(e.target === emptyMask) closeEmptyModal(); });
  btnGoSettingsFromEmpty.addEventListener("click", ()=>{ closeEmptyModal(); openTab("settings"); });
  btnGoEditFromEmpty.addEventListener("click", ()=>{ closeEmptyModal(); openTab("edit"); });

  // Confirm modal buttons
  btnCloseConfirm.addEventListener("click", closeConfirmModal);
  btnCancelSave.addEventListener("click", closeConfirmModal);
  confirmMask.addEventListener("click", (e)=>{ if(e.target === confirmMask) closeConfirmModal(); });
  btnConfirmSave.addEventListener("click", confirmSave);

  // Settle modal
  btnOpenSettle.addEventListener("click", openSettleModal);
  btnCloseSettle.addEventListener("click", closeSettleModal);
  settleMask.addEventListener("click", (e)=>{ if(e.target === settleMask) closeSettleModal(); });
  btnCopySettle.addEventListener("click", async ()=>{
    const text = buildSettleText();
    try{
      await navigator.clipboard.writeText(text);
      alert("已复制。");
    }catch(e){
      prompt("复制失败（可能是浏览器权限限制），请手动复制：", text);
    }
  });

  window.addEventListener("resize", ()=>{ drawLineChart(); });

  // ---------- Init ----------
  if(![2,3,4].includes(state.playerCount)) state.playerCount = 4;
  if(!state.meta) state.meta = { emptyGuideShownOnce:false };
  normalizePlayers();
  saveState();

  rebuildAll("init");
  openTab("home");
  maybeAutoShowEmptyGuide("init");
})();
</script>

</body>
</html>
